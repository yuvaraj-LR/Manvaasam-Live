let imageUploader = {
  init: (myclass) => {
    let createContainer = function () {
      let $container = $("<div>", { class: "image-uploader" });
      $("<input>", {
        type: "text",
        id: "imageNames",
        class: "d-none",
        name: "imageNames",
      }).appendTo($container);
      let $input = $("<input>", {
        type: "file",
        accept: ".jpg, .png, .jpeg",
        id: imageID,
        name: $(myclass).attr("id") + "[]",
        multiple: "",
      }).appendTo($container);
      if ($(myclass).attr("id") == "assets") {
        $input = $("<input>", {
          type: "file",
          accept: "*",
          id: imageID,
          name: $(myclass).attr("id") + "[]",
          multiple: "",
        }).appendTo($container);
      }
      $uploadedContainer = $("<div>", {
        class: "uploaded",
      }).appendTo($container);
      $textContainer = $("<div>", {
        class: "upload-text p-3",
      }).appendTo($container);
      $i = $(
        `<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" width="10rem" height="10rem" viewBox="0 0 24 24"><path d="M13 19v-4h3l-4-5l-4 5h3v4z" fill="var(--ec-primary-color)"/><path d="M7 19h2v-2H7c-1.654 0-3-1.346-3-3c0-1.404 1.199-2.756 2.673-3.015l.581-.102l.192-.558C8.149 8.274 9.895 7 12 7c2.757 0 5 2.243 5 5v1h1c1.103 0 2 .897 2 2s-.897 2-2 2h-3v2h3c2.206 0 4-1.794 4-4a4.01 4.01 0 0 0-3.056-3.888C18.507 7.67 15.56 5 12 5C9.244 5 6.85 6.611 5.757 9.15C3.609 9.792 2 11.82 2 14c0 2.757 2.243 5 5 5z" fill="var(--ec-primary-color)"/></svg>`
      ).appendTo($textContainer);
      $span = $("<span>", {
        text: "Drag & Drop files here or click to browse",
      }).appendTo($textContainer);
      $container.on("click", function (e) {
        prevent(e);
        $input.trigger("click");
      });
      $input.on("click", function (e) {
        e.stopPropagation();
      });
      $input.on("change", fileSelectHandler.bind($container));
      return $container;
    };
    let prevent = function (e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    };
    let uploadImage = function (file, id) {
      var formdata = new FormData();
      formdata.append("image", file);
      $.ajax({
        url: `${_xUserData.baseURL}admin/api/upload.php?auth=${
          _xUserData.auth
        }&username=${_xUserData.username}&id=${id}&type=${$(myclass).attr(
          "id"
        )}`,
        type: "POST",
        data: formdata,
        processData: false,
        contentType: false,
        success: function (response) {
          if (response.error.code === "#200") {
            let inputValue = $(`input[name='imageNames']`).val();
            $("input[name='imageNames']").val(
              inputValue + "," + response.data.id
            );
            $(`.uploaded-image[data-index='${id}']`).attr(
              "data-name",
              response.data.id
            );
            swal({
              title: "Success",
              text: response.data.image_url,
              icon: "success",
              confirmButtonText: "OK",
            });
            console.log(response);
          } else {
            alert("File not uploaded");
          }
        },
        error: function (error) {
          alert("File not uploaded");
        },
      });
    };
    let removeContainer = function ($buttonThis) {
      currentFiles--;
      let $container = $buttonThis.closest(".uploaded-image");
      let image = $container.data("image");
      let $index = $container.data("index");

      let inputValue = $(`input[name='imageNames']`).val();
      let newValue = inputValue.replace(`,${image}`, "");
      console.log(inputValue);
      $(`input[name='imageNames']`).val(newValue);

      if ($container.data("name")) {
        let name = $container.data("name");
        let arrIndex = previewedFiles.indexOf(name);
        if (arrIndex !== -1) {
          previewedFiles.splice(arrIndex, 1);
        }
      }
      $container.remove();
      if (currentFiles <= 0) {
        $(".upload-text").css("display", "flex");
        $(".image-uploader").removeClass("has-files");
      }
    };
    let createImg = function (file, id, name) {
      if (!previewedFiles.includes(name)) {
        let $container = $("<div>", {
            class: "uploaded-image",
          }),
          $wrapper = $("<div>", {
            class: "wrapper",
          }).appendTo($container),
          $button = $("<a>", {
            class: "delete-image",
            "data-id": id,
            "data-index": id,
          }).appendTo($container);
        $("<img>", { src: URL.createObjectURL(file) }).appendTo($wrapper);
        $(
          `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59L7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12L5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z" fill="var(--ec-primary-color)"/></svg>`
        ).appendTo($button);
        $container.attr("data-index", id);
        $container.attr("data-name", name);
        previewedFiles.push(name);
        console.log(previewedFiles);
        $container.on("click", function (e) {
          prevent(e);
        });
        $(".upload-text").hide();
        $button.on("click", function (e) {
          prevent(e);
          removeContainer($(this));
        });
        uploadImage(file, id);
        return $container;
      } else {
        alert("This file Uploaded");
      }
    };
    let fileDragHover = function (e) {
      prevent(e);
      if (e.type === "dragover") {
        $(this).addClass("drag-over");
      } else {
        $(this).removeClass("drag-over");
      }
    };
    let fileSelectHandler = function (e) {
      prevent(e);
      let $container = $(this);
      $container.removeClass("drag-over");
      let files = e.target.files || e.originalEvent.dataTransfer.files;
      setPreview($container, files);
    };
    let setPreview = function ($container, files) {
      $container.addClass("has-files");
      let $uploadedContainer = $container.find(".uploaded"),
        $input = $container.find('input[type="file"]');
      $(files).each(function (i, file) {
        let acceptedTypes = ["jpg", "jpeg", "png"];
        dataTransfer.items.add(file);
        var fileExtension = file.name.substring(
          file.name.lastIndexOf(".") + 1,
          file.name.length
        );
        // Check For valid Extensions
        if (acceptedTypes.includes(fileExtension) || $(myclass).attr("id") == "assets") {
          // Check for 2MB Max size
          if (file.size < 2000000) {
            currentFiles++;
            $uploadedContainer.append(
              createImg(file, dataTransfer.items.length - 1, file.name)
            );
          } else {
            alert("This File is is Larger than out Limit");
          }
        } else {
          alert("File Format is not valid.(Only JPG, JPEG or PNG)");
        }
        if (currentFiles <= 0) {
          $(".image-uploader").removeClass("has-files");
        }
      });
      $input.prop("files", dataTransfer.files);
    };
    let random = function () {
      return Date.now() + Math.floor(Math.random() * 100 + 1);
    };
    const imageID = "images-" + random();
    let currentFiles = 0;
    let $uploadedContainer;
    let previewedFiles = [];
    let $container = createContainer();
    $(myclass).append($container);
    let dataTransfer = new DataTransfer();

    if (_xUserData.alreadyUploaded) {
      $images = _xUserData.alreadyUploaded.split(",");
      for (let i = 0; i < $images.length; i++) {
        if ($images[i] !== "") {
          currentFiles++;
          let $container = $("<div>", {
              class: "uploaded-image",
            }),
            $wrapper = $("<div>", {
              class: "wrapper",
            }).appendTo($container),
            $button = $("<a>", {
              class: "delete-image",
              "data-id": $images[i],
              "data-index": i + 1,
            }).appendTo($container);
          $("<img>", {
            src: `${_xUserData.baseURL}/admin/uploads/images/${$images[i]}`,
          }).appendTo($wrapper);
          $(
            `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59L7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12L5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z" fill="var(--ec-primary-color)"/></svg>`
          ).appendTo($button);
          $container.attr("data-index", i + 1);
          $container.attr("data-name", $images[i]);
          previewedFiles.push($images[i]);
          console.log(previewedFiles);
          $container.on("click", function (e) {
            prevent(e);
          });
          $(".upload-text").hide();
          $button.on("click", function (e) {
            prevent(e);
            removeContainer($(this));
          });
          $uploadedContainer.append($container);
        }
      }
    }

    $container.on("dragover", fileDragHover.bind($container));
    $container.on("dragleave", fileDragHover.bind($container));
    $container.on("drop", fileSelectHandler.bind($container));
  },
};
